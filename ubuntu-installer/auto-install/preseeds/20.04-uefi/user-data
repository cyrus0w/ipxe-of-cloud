#cloud-config
autoinstall:
  version: 1
  early-commands:
    - systemctl stop ssh # otherwise packer tries to connect and exceed max attempts
  locale: en_US.UTF-8
  keyboard:
    layout: en
    variant: uk
  network:
    network:
        version: 2
        #renderer: networkd #在桌面版中，gui界面设置网络用的服务是NetworkManager（systemctl mask NetworkManager），命令行设置用的是networkd服务，这一行可以不加，也可以添加，设置所选的服务，具体可以百度
        ethernets:
            #动态地址配置
            eth0:
               dhcp4: yes
               dhcp-identifier: mac
            #静态地址配置
            #eth0:
            #  dhcp4: no
            #  dhcp-identifier: mac
            #  addresses: [192.168.94.15/24]
            #  gateway4: 192.168.94.2
            #  nameservers:
            #     addresses: [114.114.114.114]
  storage:
    grub:
      reorder_uefi: False
    swap:
      size: 2000MB
    config:
    - {ptable: gpt, path: /dev/sda, preserve: false, name: '', grub_device: false,
      type: disk, id: disk-sda}
    - {device: disk-sda, size: 250MB, wipe: superblock, flag: boot, number: 1,
      preserve: false, grub_device: true, type: partition, id: partition-sda1}
    - {fstype: fat32, volume: partition-sda1, preserve: false, type: format, id: format-2}
    - {device: disk-sda, size: 500MB, wipe: superblock, flag: linux, number: 2,
      preserve: false, grub_device: false, type: partition, id: partition-sda2}
    - {fstype: ext4, volume: partition-sda2, preserve: false, type: format, id: format-0}
    - {device: disk-sda, size: -1, wipe: superblock, flag: linux, number: 3, preserve: false,
      grub_device: false, type: partition, id: partition-sda3}
    - name: vg-0
      devices: [partition-sda3]
      preserve: false
      type: lvm_volgroup
      id: lvm-volgroup-vg-0
    - {name: lv-root, volgroup: lvm-volgroup-vg-0, size: 100%, preserve: false,
      type: lvm_partition, id: lvm-partition-lv-root}
    - {fstype: ext4, volume: lvm-partition-lv-root, preserve: false, type: format,
      id: format-1}
    - {device: format-1, path: /, type: mount, id: mount-2}
    - {device: format-0, path: /boot, type: mount, id: mount-1}
    - {device: format-2, path: /boot/efi, type: mount, id: mount-3}
  apt:
    preserve_sources_list: false
    primary:
      - arches: [amd64]
        uri: "http://mirrors.163.com/ubuntu/"
  ssh:
    install-server: yes
    authorized-keys:
      - "your SSH pub key here"
    allow-pw: true
  identity:
    hostname: ubuntu2004
    password: "$6$/NOmHB1DMW8$9hXOGPJeuAfWYE.BKC2m3wj8iS37119YprrnSR.7GNntFOvmOcrCnaeEhVItvs.faGnlpJa8OoQXknMV5Rhnd/" # mvtech@123
    username: ops # root doesn't work
  packages:
    - open-vm-tools
    - openssh-server
    - wget
    - vim
  user-data:
    disable_root: false 
    timezone: Asia/Shanghai                       
  late-commands:
    - echo 'ops ALL=(ALL) NOPASSWD:ALL' > /target/etc/sudoers.d/ops             #允许普通账户免密sudo su
    - sed -ie 's/GRUB_CMDLINE_LINUX=.*/GRUB_CMDLINE_LINUX="net.ifnames=0 biosdevname=0"/' /target/etc/default/grub
    - curtin in-target --target /target update-grub2
    - sed -i 's/.*UseDNS.*/UseDNS no/' /target/etc/ssh/sshd_config
    - echo 'AddressFamily inet' >> /target/etc/ssh/sshd_config
    - sed -i 's/.*PermitRootLogin.*/PermitRootLogin yes/' /target/etc/ssh/sshd_config
    - echo 'PermitRootLogin yes' >> /target/etc/ssh/sshd_config
    - sed -i 's/.*compatible.*/set nocompatible/g' /target/etc/vim/vimrc.tiny      #ubuntu vi方向错乱解决
    - echo "set backspace=2" >> /target/etc/vim/vimrc.tiny                     #ubuntu vi方向错乱解决
    - sed -i 's/1000/5000/g'  /target/etc/login.defs
    - if [ -d /target/etc/gdm3 ];then
       sed -i 's/.*pam_succeed_if.so.*/#auth   required   pam_succeed_if.so user != root quiet_success/' /target/etc/pam.d/gdm-password;
       sed -i 's/.*pam_succeed_if.so.*/#auth   required   pam_succeed_if.so user != root quiet_success/' /target/etc/pam.d/gdm-autologin;
       sed -i 's/.*AutomaticLoginEnabl.*/AutomaticLoginEnabl = true/' /target/etc/gdm3/custom.conf;
       sed -i 's/.*AutomaticLogin.*/AutomaticLogin = root/' /target/etc/gdm3/custom.conf;
      fi

  error-commands:
    - tar cfz - /var/log/installer | nc 192.168.122.1 1000       # 接收端命令：nc -l 1000 | tar xfvz -      